<!DOCTYPE html>
<html>

<body>


<div class="modal fade" id="scanBarcodeModal" tabindex="9" role="modal" aria-labelledby="modal-label" aria-hidden="true" style="display: none; overflow-y: auto !important;">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			</div>

			<h1 class="title">Scan barcode from Video Camera</h1>
			<div>
				<a class="button small green button-3d rounded icon-left" id="startButton">Start</a>
			</div>

			<div>
				<video id="video" width="600" height="400" style="border: 1px solid gray"></video>
			</div>

			<div id="sourceSelectPanel" style="display:none">
				<label for="sourceSelect">Changer de caméra :</label>
				<select id="sourceSelect" style="max-width:400px">
				</select>
			</div>

			<label>Result:</label>
			<input id="result"></input>
			<div class="modal-footer">
				<button type="button" class="btn btn-b" data-dismiss="modal"><?= L::generic_close; ?></button>
			</div>
		</div>
	</div>
</div>


<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
<script type="text/javascript">
	window.addEventListener('load', function () {
		let selectedDeviceId;
		const codeReader = new ZXing.BrowserBarcodeReader()
		console.log('ZXing code reader initialized')
		codeReader.getVideoInputDevices()
		.then((videoInputDevices) =>{
			const sourceSelect = document.getElementById('sourceSelect');
			console.log(sourceSelect);
			selectedDeviceId = videoInputDevices[0].deviceId;
			if (videoInputDevices.length > 1) {
				videoInputDevices.forEach((element) => {
					const sourceOption = document.createElement('option')
					sourceOption.text = element.label
					sourceOption.value = element.deviceId
					sourceSelect.appendChild(sourceOption)
				})

				sourceSelect.onchange = () => {
					selectedDeviceId = sourceSelect.value;
				}

				const sourceSelectPanel = document.getElementById('sourceSelectPanel')
				sourceSelectPanel.style.display = 'block'
			}

			document.getElementById('startButton').addEventListener('click', () => {
				codeReader.decodeOnceFromVideoDevice(selectedDeviceId, 'video').then((result) => {
					console.log(result)
					document.getElementById('result').value = result.text
				}).catch((err) => {
					console.error(err)
					document.getElementById('result').value = err
				})
				console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
			})
		})
		.catch((err) => {
			console.error(err);
		})
	})
</script>

</body>
</html>
